name: 🧪 E2E Tests

on:
  schedule:
    # Exécuter tous les jours à 6h UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'app-lecture/**'

env:
  WORKING_DIRECTORY: './app-lecture'

jobs:
  e2e-tests:
    name: 🎮 End-to-End Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout code
      uses: actions/checkout@v4
      
    - name: 📦 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ${{ env.WORKING_DIRECTORY }}/package-lock.json
        
    - name: 📥 Install dependencies
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: npm ci
      
    - name: 📦 Install Playwright
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: npx playwright install --with-deps
      
    - name: 🏗️ Build application
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: npm run build
      env:
        NEXT_PUBLIC_SUPABASE_URL: 'https://placeholder.supabase.co'
        NEXT_PUBLIC_SUPABASE_ANON_KEY: 'placeholder-anon-key'
        
    - name: 🚀 Start application
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: npm start &
      env:
        PORT: 3000
        
    - name: ⏱️ Wait for application
      run: npx wait-on http://localhost:3000 --timeout 60000
      
    - name: 🧪 Run E2E tests
      working-directory: ${{ env.WORKING_DIRECTORY }}
      run: npm run test:e2e
      
    - name: 📤 Upload test reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: playwright-report
        path: ${{ env.WORKING_DIRECTORY }}/playwright-report/
        retention-days: 7
        
    - name: 📤 Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: ${{ env.WORKING_DIRECTORY }}/test-results/
        retention-days: 7
